-- Create the database
CREATE DATABASE opilaneOdinokov;
USE opilaneOdinokov;

-- Create Table Isik
CREATE TABLE Isik (
    id int PRIMARY KEY IDENTITY(1,1),
    eesnimi VARCHAR(50),
    perenimi VARCHAR(50),
    sugu CHAR(1),
    sünnikuupäev DATE,
    aadress VARCHAR(100),
    email VARCHAR(50)
);

-- Create Table Õppeaine
CREATE TABLE Õppeaine (
    id int PRIMARY KEY IDENTITY(1,1),
    nimetus VARCHAR(50),
    vastutav_õpetaja INTEGER,
    aine_kestus VARCHAR(50),
    FOREIGN KEY (vastutav_õpetaja) REFERENCES Isik(id)
);

-- Create Table Õppimine
CREATE TABLE Õppimine (
    id int PRIMARY KEY IDENTITY(1,1),
    isik_id INTEGER,
    õppeaine_id INTEGER,
    hinne INTEGER,
    FOREIGN KEY (isik_id) REFERENCES Isik(id),
    FOREIGN KEY (õppeaine_id) REFERENCES Õppeaine(id)
);

-- Create Table logi
CREATE TABLE logi (
    id INT IDENTITY(1,1) PRIMARY KEY,
    kasutaja NVARCHAR(50),
    kuupäev DATETIME DEFAULT GETDATE(),
    sisestatudAndmed NVARCHAR(MAX)
);

-- Trigger for updating Õppimine
CREATE TRIGGER ÕppimineUuendamine
ON Õppimine
FOR UPDATE
AS
BEGIN
    INSERT INTO logi (kasutaja, kuupäev, sisestatudAndmed)
    SELECT SYSTEM_USER,
           GETDATE(),
           CONCAT('Vanad: IsikID: ', deleted.isik_id, ', ÕppeaineID: ', deleted.õppeaine_id, ', Hinne: ', deleted.hinne, 
                  ' Uued: IsikID: ', inserted.isik_id, ', ÕppeaineID: ', inserted.õppeaine_id, ', Hinne: ', inserted.hinne)
    FROM deleted 
    INNER JOIN inserted ON deleted.id = inserted.id;
END;

-- Trigger for inserting into Õppimine
CREATE TRIGGER ÕppimineLisamine
ON Õppimine
FOR INSERT
AS
BEGIN
    INSERT INTO logi (kasutaja, kuupäev, sisestatudAndmed)
    SELECT SYSTEM_USER,
           GETDATE(),
           CONCAT('Õppimine on lisatud: IsikID: ', inserted.isik_id, ', ÕppeaineID: ', inserted.õppeaine_id, ', Hinne: ', inserted.hinne)
    FROM inserted;
END;



-- Insert sample data into Isik
INSERT INTO Isik (eesnimi, perenimi, sugu, sünnikuupäev, aadress, email) 
VALUES 
('Kati', 'Kask', 'N', '1988-02-10', 'Tartu, Eesti', 'kati.kask@example.com'),
('Mihkel', 'Mets', 'M', '1992-09-25', 'Viljandi, Eesti', 'mihkel.mets@example.com'),
('Laura', 'Lepp', 'N', '1995-07-18', 'Rakvere, Eesti', 'laura.lepp@example.com'),
('Jaan', 'Tamm', 'M', '1990-11-05', 'Tallinn, Eesti', 'jaan.tamm@example.com'),
('Liisa', 'Põld', 'N', '1985-03-22', 'Pärnu, Eesti', 'liisa.pold@example.com');

-- Insert sample data into Õppeaine
INSERT INTO Õppeaine (nimetus, vastutav_õpetaja, aine_kestus) 
VALUES 
('Matemaatika', 1, '4 kuud'),
('Füüsika', 2, '3 kuud'),
('Keemia', 3, '3 kuud'),
('Bioloogia', 4, '4 kuud'),
('Ajalugu', 5, '2 kuud');

-- Insert sample data into Õppimine
INSERT INTO Õppimine (isik_id, õppeaine_id, hinne) 
VALUES 
(1, 1, 5),
(1, 2, 4),
(2, 1, 3),
(2, 3, 5),
(3, 4, 2),
(3, 5, 4),
(4, 2, 3),
(4, 3, 2),
(5, 1, 5),
(5, 4, 4);

-- Select statements to verify the data
SELECT * FROM Isik;
SELECT * FROM Õppeaine;
SELECT * FROM Õppimine;
SELECT * FROM logi;
